name: Build and Notify

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Trigger to allow manual execution from GitHub Actions UI

jobs:
  build_and_notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Get commit information
        if: always()
        id: commit_info
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          echo "::set-output name=commit_hash::$COMMIT_HASH"
          echo "::set-output name=branch_name::$BRANCH_NAME"
      
      - name: Determine job status and recipients
        id: status_and_recipients
        run: |
          if [ -n "${{ steps.error }}" ]; then
            STATUS="❌ FAIL"
            COLOR="attention"
            MENTIONED_ID="${{ secrets.ERROR_MENTION_ID }}"
            MENTIONED_NAME="${{ secrets.ERROR_MENTION_NAME }}"
          else
            STATUS="✅ PASS"
            COLOR="good"
            MENTIONED_ID="${{ secrets.SUCCESS_MENTION_ID }}"
            MENTIONED_NAME="${{ secrets.SUCCESS_MENTION_NAME }}"
          fi
          
          echo "::set-output name=status::$STATUS"
          echo "::set-output name=color::$COLOR"
          echo "::set-output name=mentionedId::$MENTIONED_ID"
          echo "::set-output name=mentionedName::$MENTIONED_NAME"
      
      - name: Send notification to Microsoft Teams
        if: always()
        run: |
          # Get the GitHub workflow run URL
          JOB_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Get the commit information from previous step
          COMMIT_HASH=${{ steps.commit_info.outputs.commit_hash }}
          BRANCH_NAME=${{ steps.commit_info.outputs.branch_name }}
          
          # Get the repository URL
          REPO_URL="[${{ github.repository }}](${{ github.event.repository.html_url }})"
          
          # Get the build number
          BUILD_NUMBER="${{ github.run_number }}"
          
          # Get the status and recipients from previous step
          STATUS=${{ steps.status_and_recipients.outputs.status }}
          COLOR=${{ steps.status_and_recipients.outputs.color }}
          MENTIONED_ID=${{ steps.status_and_recipients.outputs.mentionedId }}
          MENTIONED_NAME=${{ steps.status_and_recipients.outputs.mentionedName }}
          
          # Send the payload to Microsoft Teams
          echo "Job Name: Build and Notify
          Job URL: $JOB_URL
          Status: $STATUS
          Repository URL: $REPO_URL
          Build Number: $BUILD_NUMBER
          Branch Name: $BRANCH_NAME
          Latest Commit: $COMMIT_HASH" |
          curl -X POST -H 'Content-Type: application/json' -d @- "${{ secrets.MICROSOFT_TEAMS_WEBHOOK_URL }}"
